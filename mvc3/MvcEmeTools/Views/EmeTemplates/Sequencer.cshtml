@model Dominio.Entidades.Escripte
@{
    ViewBag.Title = "Sequencer";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@Html.Partial("menu_edit_sequencer", Model.IdSha1)
<h2>
    Sequencer</h2>
@section js{
    <script src="@Url.Content("~/Scripts/jquery.textchange.min.js")" type="text/javascript"> </script>
    <script src="@Url.Content("~/Scripts/jsed/jsed.js")" type="text/javascript"> </script>
    <script src="@Url.Content("~/Scripts/EmeTools/emetools.js")" type="text/javascript"> </script>
    <script type="text/javascript">
        $().ready(function () {
            var selecionarEtapa = function (elJquery) {
                // limpa os itens selecionados
                $("#listaXixizeros li").attr("class", "naoSelecionado");

                // seleciona o item atual
                elJquery.attr("class", "selecionado");

                // pega o indice
                var html = elJquery.html();
                var indiceSelecionado = parseInt(html.replace(/^\[([-\d]+)\].*/, "$1"));

                // recupera resultado do indice
                if (indiceSelecionado >= 0) {
                    $("#preXixizero").html(replace_show_invisible(roboXixi.Xixizeros[indiceSelecionado].Escripte));
                    $("#preResposta").html(replace_show_invisible(roboXixi.Xixizeros[indiceSelecionado].DadoTransformado));
                } else {
                    $("#preXixizero").html('');
                    $("#preResposta").html(replace_show_invisible(roboXixi.DadosIniciais));
                }
            };

            // executa toda transformação
            var texto = $("#preEscripteCompleto").html();
            var roboXixi = new RoboXixi(texto, '\n');
            roboXixi.Transformar();

            // cria a lista dos passos
            for (var i = 0; i < roboXixi.Xixizeros.length; i++) {
                var xixizero = roboXixi.Xixizeros[i];
                $("#listaXixizeros").append("<li>[" + i + "]: " + xixizero.PrimeiroComentario() + "</li>");
            }

            // Executa toda transformação
            $("#preResposta").html(roboXixi.ResultadoFinal);

            // coloca evento para mudar a visualização dos resultados
            $("#listaXixizeros li").click(function () {
                selecionarEtapa($(this));
            });

            // CTRL + CIMA
            $.ctrl(38, function () {
                var anterior = $(".selecionado").prev();
                if (anterior.length === 0)
                    return false;
                selecionarEtapa(anterior);
                return false;
            });
            // CTRL + BAIXO
            $.ctrl(40, function () {
                var proximo = $(".selecionado").next();
                if (proximo.length === 0)
                    return false;
                selecionarEtapa(proximo);
                return false;
            });


            // Ativa botão para copiar para o clipboard
            var xixizeroParaCopia = function () {
                // pega o indice
                var indiceSelecionado = parseInt($(".selecionado").html().replace(/^\[([-\d]+)\].*/, "$1"));

                if (indiceSelecionado < 0)
                    return '';

                var dadosAntesTransformacao = '';

                if (indiceSelecionado == 0) {
                    dadosAntesTransformacao = roboXixi.DadosIniciais;
                }
                else {
                    // pega o dado anterior
                    dadosAntesTransformacao = roboXixi.Xixizeros[indiceSelecionado - 1].DadoTransformado;
                }

                var resultado = dadosAntesTransformacao + "\n";
                // pega o escript atual
                var xixizeroProximo = roboXixi.Xixizeros[indiceSelecionado];
                resultado += "///" + xixizeroProximo.Comando + "\n";
                resultado += xixizeroProximo.Escripte + "\n";
                return resultado;
            };

            $("#spanCopyLink").click(function () {
                $("#preEscripteCompleto").text(xixizeroParaCopia());
                $("#preEscripteCompleto")[0].focus();
                $("#preEscripteCompleto")[0].select();

                $("#spanCopyLink").text('copiado. Digite Ctrl + C agora...');

                var timeout;
                clearTimeout(timeout);
                timeout = setTimeout(function () {
                    $("#spanCopyLink").text('copy');
                }, 2000);
            });
        });

        $.ctrl = function (key, callback, args) {
            var isCtrl = false;
            $(document).keydown(function (e) {
                if (!args) args = []; // IE barks when args is null

                if (e.ctrlKey) isCtrl = true;
                if (e.keyCode == key && isCtrl) {
                    callback.apply(this, args);
                    e.preventDefault();
                    return false;
                }
            }).keyup(function (e) {
                if (e.ctrlKey) isCtrl = false;
            });
        };


    </script>
}
<style>
    #container
    {
        width: 900px;
    }
    
    
    #divListaXixizeros
    {
        border-color: #eee;
        border-style: solid;
        float: left;
        width: 100%;
        padding: 8px;
    }
    
    #divEscripte
    {
        border-color: #eee;
        border-style: solid;
        float: left;
        width: 100%;
        padding: 8px;
    }
    
    #preXixizero
    {
        font-size: 14pt;
        background-color: #fcfcfc;
        border-color: #efe;
        border-style: solid;
        height: 100%;
        width: 880px;
    }
    
    #listaXixizeros li
    {
        border-color: #eee;
        border-style: solid;
        border-width: 1px;
        padding: 2px;
        width: 90%;
        font-size: 10pt;
        cursor: pointer;
    }
    
    #divResultadoParcial
    {
        border-color: #eee;
        border-style: solid;
        padding: 8px;
        float: left;
        width: 880px;
    }
    
    .naoSelecionado
    {
        background-color: #fff;
    }
    .selecionado
    {
        background-color: #fee;
    }
    
    #divCopyLink
    {
        border-color: #eee;
        border-style: solid;
        text-align: right;
        width: 100%;
    }
    #spanCopyLink
    {
        cursor: pointer;
        text-decoration: underline;
    }
    #preEscripteCompleto
    {
        width: 100px;
        height: 20px;
        font-size: 8pt;
    }
    
    .subTitulo
    {
        padding: 3px;
        font-size: 11pt;
        background-color: #eee;
    }
</style>
<fieldset>
    <legend>@Model.Nome</legend>
    <div id="container">
        <div id="divListaXixizeros">
            <div class="subTitulo">
                sequência</div>
            <ul id="listaXixizeros">
                <li>[-1]: ORIGINAL</li>
            </ul>
        </div>
        <div id="divEscripte">
            <div class="subTitulo">
                escripte</div>
            <pre id="preXixizero"></pre>
        </div>
        <div id="divResultadoParcial">
            <div class="subTitulo">
                resultado</div>
            <pre id="preResposta"></pre>
        </div>
        <div id="divCopyLink">
            <span id="spanCopyLink">copy</span>
            <br />
            @*style="display: none"*@
            <textarea id="preEscripteCompleto">@Model.Texto</textarea>
        </div>
    </div>
    <br />
</fieldset>
<p>
    @Html.ActionLink("Edit", "Edit", new { id = Model.IdSha1 }) |
    @Html.ActionLink("Back to List", "Index")
</p>
